<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- PWA Settings -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Romeo Spelling">
<link rel="apple-touch-icon" href="https://img.icons8.com/color/180/lego-head.png">
<!-- Google Fonts for Art Text -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

<title>Romeo's Spelling practice</title>
<style>
  :root {
    --bg: #f2f6fa; --card: #ffffff; --primary: #007AFF; 
    --lego-yellow: #FFCF00; --lego-red: #ff3b30; --text: #1d1d1f;
    --success: #34C759;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text);
    height: 100vh; display: flex; flex-direction: column;
    overflow: hidden; 
  }

  /* --- Layout --- */
  header {
    background: rgba(255,255,255,0.95);
    padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top));
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .brand { display: flex; align-items: center; gap: 12px; }
  .avatar {
    width: 44px; height: 44px; background: var(--lego-yellow);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 24px; color: #333;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1); 
    font-family: 'Fredoka One', cursive; 
  }
  h1 { margin: 0; font-size: 18px; color: #000; font-weight: 700; }
  .subtitle { font-size: 12px; color: #888; font-weight: 400; }

  /* --- Main Container --- */
  #app {
    flex: 1; overflow-y: auto; padding: 20px;
    padding-bottom: max(30px, env(safe-area-inset-bottom));
  }

  /* --- Hero Title (Art Font) --- */
  .hero-title {
    font-family: 'Fredoka One', cursive; 
    font-size: 56px; 
    color: #333; 
    text-shadow: 3px 3px 0px #ddd;
    margin-bottom: 10px;
    letter-spacing: 1px;
  }
  
  /* --- Components --- */
  .card {
    background: var(--card); border-radius: 16px; padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 16px;
    border: 1px solid rgba(0,0,0,0.02);
  }
  
  /* Buttons */
  .btn {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    width: 100%; padding: 16px; 
    border: none; border-radius: 14px;
    font-size: 17px; font-weight: 600; cursor: pointer;
    margin-bottom: 14px; transition: transform 0.1s;
    text-align: center;
    box-shadow: 0 4px 0 rgba(0,0,0,0.05);
  }
  .btn:active { transform: scale(0.98) translateY(2px); box-shadow: none; }
  
  .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 0 #005bb5; }
  .btn-yellow { background: var(--lego-yellow); color: #000; box-shadow: 0 4px 0 #d4ac00; }
  .btn-green { background: var(--success); color: #fff; box-shadow: 0 4px 0 #248a3d; }
  .btn-outline { background: #fff; color: var(--primary); border: 2px solid #eef2f6; box-shadow: none; }
  .btn-red { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; box-shadow: none; }
  
  .btn-row { display: flex; gap: 12px; margin-top: 10px; }
  .btn-small {
    flex: 1; padding: 10px; font-size: 14px; border-radius: 10px;
    background: #f1f3f7; color: #666; border: none; font-weight: 600;
  }

  /* --- Practice Mode UI --- */
  .word-display {
    text-align: center; margin: 20px 0;
    min-height: 120px; display: flex; flex-direction: column; justify-content: center;
  }
  .word-text { font-size: 52px; font-weight: 700; font-family: "Courier New", monospace; letter-spacing: 2px; color: #111; }
  .phonics { font-size: 24px; color: #555; margin-top: 8px; font-weight: 500; background:#e3f2fd; color:#1565c0; display:inline-block; padding:4px 14px; border-radius:20px; margin: 10px auto 0;}
  
  .blanks-container {
    display: flex; justify-content: center; flex-wrap: wrap; gap: 8px;
    margin: 30px 0; cursor: text;
  }
  .blank-char {
    width: 48px; height: 58px;
    border-bottom: 4px solid #e0e0e0;
    font-size: 32px; font-weight: 600;
    display: flex; align-items: center; justify-content: center;
    background: #fff; color: #333; border-radius: 8px;
    transition: all 0.2s;
  }
  .blank-char.active { border-bottom-color: var(--primary); background: #f0f7ff; transform: translateY(-2px); }
  .blank-char.filled { border-bottom-color: #333; }
  .blank-char.correct { color: #fff; background: var(--success); border-bottom-color: var(--success); border:none; }
  .blank-char.wrong { color: #fff; background: var(--lego-red); border-bottom-color: var(--lego-red); border:none; }

  /* --- Achievement Page --- */
  .rocket-stage {
    background: linear-gradient(135deg, #0b1e3b, #1a3a6c); color: #fff; border-radius: 20px; padding: 30px 20px;
    text-align: center; margin-bottom: 20px; position: relative; overflow: hidden;
  }
  .big-score { font-size: 56px; font-weight: 900; margin: 10px 0; text-shadow: 0 4px 10px rgba(0,0,0,0.3); font-family: 'Fredoka One', cursive; }
  .icons-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; font-size: 24px; }
  
  /* Manage List */
  .manage-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
  }
  .manage-item:last-child { border-bottom: none; }
  .manage-item:active { background: #f9f9f9; }

  .history-item {
    background: #fff; border-radius: 14px; margin-bottom: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02); overflow: hidden;
  }
  .history-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; cursor: pointer; }
  .history-date { font-weight: 700; color: #333; }
  .history-count { color: #666; font-size: 14px; display: flex; align-items: center; gap: 6px; }
  .history-details { padding: 0 16px 16px 16px; display: none; border-top: 1px solid #f0f0f0; }
  .history-details.show { display: block; }
  .detail-tag { display: inline-block; background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 6px; font-size: 13px; margin: 8px 4px 0 0; font-weight: 600; }
  .word-wall { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
  .wall-item { background: #fff; border: 1px solid #eee; padding: 6px 10px; border-radius: 8px; font-size: 14px; font-weight: 600; color: #444; }

  /* Inputs */
  #hiddenInput { position: fixed; top: -100px; left: 0; opacity: 0; font-size: 16px; }
  #fileInput { display: none; }
  textarea { width: 100%; border: 2px solid #e0e0e0; border-radius: 12px; padding: 14px; font-size: 16px; background: #fff; font-family: inherit; transition: border 0.2s;}
  textarea:focus { border-color: var(--primary); outline: none; }
  input[type="date"] { font-family: inherit; }

  /* Overlay */
  #startOverlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.98); z-index: 100;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
</style>
</head>
<body>

<!-- Hidden Inputs -->
<input type="text" id="hiddenInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
<input type="file" id="fileInput" accept=".json" onchange="importData(this)">

<!-- Header -->
<header>
  <div class="brand">
    <div class="avatar">R</div>
    <div>
      <h1>Romeo's Spelling</h1>
      <div class="subtitle">Phonics Practice</div>
    </div>
  </div>
  <div id="headerBtn"></div>
</header>

<!-- App Content -->
<div id="app"></div>

<!-- iOS Audio Unlock Overlay -->
<div id="startOverlay">
  <div class="avatar" style="width:100px;height:100px;font-size:50px;margin-bottom:24px;box-shadow:0 12px 24px rgba(0,0,0,0.15)">R</div>
  <h2 style="margin-bottom:8px;font-size:32px;font-family:'Fredoka One',cursive">Ready?</h2>
  <p style="color:#888;margin-bottom:32px">ç‚¹å‡»å¼€å§‹ä»¥å¯ç”¨å£°éŸ³</p>
  <button class="btn btn-primary" style="width:220px" onclick="unlockAudio()">ğŸš€ LET'S GO</button>
</div>

<script>
// --- 1. Global State & DB ---
let db;
let currentSetDate = null;
let practiceList = []; 
let currentIndex = 0;
let stage = 1; 
let wrongList = []; 
let sessionMasteredSet = new Set(); 
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSuccessTone() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(500, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.5);
}

// --- 2. Database Init (V4) ---
const DB_REQ = indexedDB.open('romeo_spelling_v4', 1);

DB_REQ.onupgradeneeded = (e) => {
  db = e.target.result;
  if (!db.objectStoreNames.contains('wordSets')) db.createObjectStore('wordSets', { keyPath: 'date' });
  if (!db.objectStoreNames.contains('wrongBank')) db.createObjectStore('wrongBank', { keyPath: 'word' });
  if (!db.objectStoreNames.contains('practiceLogs')) db.createObjectStore('practiceLogs', { keyPath: 'id', autoIncrement: true });
};
DB_REQ.onsuccess = (e) => { db = e.target.result; };
DB_REQ.onerror = (e) => console.error("DB Error", e);

// --- 3. Navigation & Views ---
const app = document.getElementById('app');
const headerBtn = document.getElementById('headerBtn');

function unlockAudio() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const u = new SpeechSynthesisUtterance('');
  speechSynthesis.speak(u);
  document.getElementById('startOverlay').style.display = 'none';
  renderHome();
}

// --- PAGE: HOME ---
function renderHome() {
  headerBtn.innerHTML = '';
  app.innerHTML = `
    <div style="margin-top:20px;text-align:center;margin-bottom:30px">
        <div class="hero-title">Hi, Romeo!</div>
        <div style="font-size:16px;color:#666;font-weight:600">ä»Šå¤©æƒ³åšç‚¹ä»€ä¹ˆï¼Ÿ</div>
    </div>

    <button class="btn btn-primary" onclick="renderSetSelection()">
      <span style="font-size:24px">ğŸš€</span> å¼€å§‹ç»ƒä¹ 
    </button>
    
    <button class="btn btn-yellow" onclick="renderRecords()">
      <span style="font-size:24px">ğŸ†</span> æˆå°± & è®°å½•
    </button>
    
    <button class="btn btn-outline" onclick="renderWordManager()">
      <span style="font-size:24px">ğŸ“‚</span> å•è¯ç®¡ç†
    </button>

    <div class="card" style="margin-top:30px;background:#fff">
      <h4 style="margin:0 0 10px 0;color:#888;font-size:12px">DATA BACKUP</h4>
      <div class="btn-row">
         <button class="btn-small" onclick="exportAllData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
         <button class="btn-small" onclick="document.getElementById('fileInput').click()">ğŸ“¥ æ¢å¤æ•°æ®</button>
      </div>
    </div>
  `;
}

// --- PAGE: WORD MANAGER ---
function renderWordManager() {
  headerBtn.innerHTML = `<button class="btn-small" onclick="renderHome()">ğŸ  é¦–é¡µ</button>`;
  const today = new Date().toISOString().slice(0, 10);
  
  const tx = db.transaction('wordSets', 'readonly');
  getAll(tx.objectStore('wordSets')).then(sets => {
    sets.sort((a,b) => b.date.localeCompare(a.date));
    
    let setsListHtml = '';
    if (sets.length === 0) {
        setsListHtml = '<div style="padding:15px;color:#999;text-align:center">æš‚æ— å†å²è®°å½•</div>';
    } else {
        setsListHtml = sets.map(s => `
            <div class="manage-item" onclick="editSet('${s.date}')">
                <div>
                    <div style="font-weight:bold;color:#333">ğŸ“… ${s.date}</div>
                    <div style="font-size:12px;color:#888;margin-top:2px">${s.words.length} ä¸ªå•è¯</div>
                </div>
                <div style="color:var(--primary);font-size:14px;font-weight:600">ç¼–è¾‘ â€º</div>
            </div>
        `).join('');
    }

    app.innerHTML = `
      <div class="card" id="managerCard">
        <h3 style="margin-top:0" id="mgrTitle">å½•å…¥ / ç¼–è¾‘å•è¯</h3>
        <div style="background:#e3f2fd;padding:10px;border-radius:8px;font-size:13px;color:#1565c0;margin-bottom:12px;line-height:1.5">
          ğŸ’¡ <b>æç¤ºï¼š</b> å¯ç”¨ "/" æˆ– "-" æŒ‡å®šåˆ†éŸ³èŠ‚ã€‚<br>ä¾‹å¦‚ï¼š<code>ap/ple</code>
        </div>
        <label class="subtitle">æ—¥æœŸ (ID)</label>
        <input type="date" id="newDate" value="${today}" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:12px;margin:8px 0 16px;background:#fff">
        <label class="subtitle">å•è¯åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª)</label>
        <textarea id="newWords" rows="6" placeholder="ä¾‹å¦‚ï¼š&#10;apple&#10;banana&#10;happy"></textarea>
        <div style="margin-top:20px;display:flex;gap:10px">
          <button class="btn btn-primary" style="flex:2" onclick="saveSet()">ğŸ’¾ ä¿å­˜ / æ›´æ–°</button>
          <button class="btn btn-red" id="delBtn" style="flex:1;display:none" onclick="deleteSetByDate()">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
        <button class="btn-small" id="cancelBtn" style="margin-top:10px;width:100%;display:none" onclick="renderWordManager()">å–æ¶ˆç¼–è¾‘ (è¿”å›æ–°å»º)</button>
      </div>
      <h4 style="margin-left:10px;margin-bottom:10px;color:#666">å†å²è¯ç»„ç®¡ç†</h4>
      <div class="card" style="padding:0">
         ${setsListHtml}
      </div>
    `;
  });
}

function editSet(date) {
    const tx = db.transaction('wordSets', 'readonly');
    tx.objectStore('wordSets').get(date).onsuccess = (e) => {
        const data = e.target.result;
        if (!data) return;
        document.getElementById('mgrTitle').innerText = "æ­£åœ¨ç¼–è¾‘: " + date;
        document.getElementById('newDate').value = data.date;
        document.getElementById('newDate').disabled = true; 
        document.getElementById('newWords').value = data.words.join('\n');
        document.getElementById('delBtn').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('app').scrollTop = 0;
    };
}

// --- PAGE: SET SELECTION ---
function renderSetSelection() {
  headerBtn.innerHTML = `<button class="btn-small" onclick="renderHome()">ğŸ  é¦–é¡µ</button>`;
  
  const tx = db.transaction(['wordSets', 'wrongBank'], 'readonly');
  Promise.all([getAll(tx.objectStore('wordSets')), getAll(tx.objectStore('wrongBank'))])
  .then(([sets, wrongs]) => {
    sets.sort((a,b) => b.date.localeCompare(a.date));
    
    let html = `
      <div style="margin-bottom:15px;display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">é€‰æ‹©è¯¾ç¨‹</h3>
        <span style="background:#eef;padding:4px 10px;border-radius:12px;font-size:12px;color:#558;font-weight:bold">${sets.length} ä¸ªä»»åŠ¡</span>
      </div>
    `;
    
    if(wrongs.length > 0) {
      html += `
        <button class="btn btn-red" style="background:#ffebee;color:#d32f2f;box-shadow:none;border:2px solid #ffcdd2" onclick="renderWrongPractice()">
          ğŸ”¥ é”™é¢˜çªå‡» (${wrongs.length} è¯)
        </button>
        <div style="height:10px"></div>
      `;
    }

    if(sets.length === 0) {
      html += `<div style="text-align:center;padding:40px;color:#999">æš‚æ— ç»ƒä¹ ï¼Œå¿«å»å½•å…¥æ–°è¯å§ï¼</div>`;
    } else {
      html += sets.map(s => {
          const previewWords = s.words.map(w => w.replace(/[\/\-]/g, '')).slice(0,5).join(', ');
          return `
            <div class="set-item" style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:#fff;border-radius:12px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.02);cursor:pointer" onclick="startPractice('${s.date}')">
              <div class="set-info">
                <strong style="font-size:17px;color:#333">ğŸ“… ${s.date}</strong>
                <span style="font-size:13px;color:#888">${previewWords}${s.words.length>5?'...':''}</span>
              </div>
              <div style="font-weight:bold;color:var(--primary);background:#eef6ff;padding:6px 12px;border-radius:10px">${s.words.length}è¯ â€º</div>
            </div>
          `;
      }).join('');
    }
    app.innerHTML = html;
  });
}

// --- PAGE: RECORDS ---
function renderRecords() {
  headerBtn.innerHTML = `<button class="btn-small" onclick="renderHome()">ğŸ  é¦–é¡µ</button>`;
  
  const tx = db.transaction('practiceLogs', 'readonly');
  getAll(tx.objectStore('practiceLogs')).then(logs => {
    logs.sort((a,b) => b.timestamp - a.timestamp);
    let totalStars = 0;
    let allMasteredWords = new Set();
    logs.forEach(l => {
        totalStars += l.count;
        if(l.words && Array.isArray(l.words)) { l.words.forEach(w => allMasteredWords.add(w.toLowerCase())); }
    });
    
    const rockets = Math.floor(totalStars / 10);
    const currentStars = totalStars % 10;
    
    let rocketsHtml = '';
    for(let i=0; i<rockets; i++) rocketsHtml += 'ğŸš€ ';
    if(rockets === 0) rocketsHtml = '<span style="font-size:14px;opacity:0.6;font-weight:normal">åŠ æ²¹ç»ƒä¹ èµšå–ç«ç®­ï¼</span>';
    
    let starsHtml = '';
    for(let i=0; i<currentStars; i++) starsHtml += 'â­ ';
    for(let i=currentStars; i<10; i++) starsHtml += '<span style="opacity:0.2">â­</span> ';

    let historyHtml = logs.length === 0 ? '<div style="text-align:center;padding:20px;color:#999">æš‚æ— è®°å½•</div>' : '';
    
    logs.forEach((log, index) => {
        const wordsArr = log.words || [];
        const wordsHtml = wordsArr.map(w => `<span class="detail-tag">${w}</span>`).join('');
        historyHtml += `
            <div class="history-item">
                <div class="history-header" onclick="toggleHistory(${index})">
                    <div>
                        <div class="history-date">${log.date}</div>
                        <div class="history-count">
                           <span>å®Œæˆ ${log.count} ä¸ªå•è¯</span>
                           <span style="font-size:10px;color:#999">â–¼</span>
                        </div>
                    </div>
                    <div style="font-weight:bold;color:#fbc02d">â­ +${log.count}</div>
                </div>
                <div class="history-details" id="hist-detail-${index}">
                    ${wordsHtml || '<span style="font-size:12px;color:#ccc">æ— è¯¦ç»†è®°å½•</span>'}
                </div>
            </div>
        `;
    });
    const wallHtml = Array.from(allMasteredWords).sort().map(w => `<div class="wall-item">${w}</div>`).join('');

    app.innerHTML = `
      <div class="rocket-stage">
        <div style="position:relative;z-index:2">
            <div style="font-size:14px;opacity:0.8;text-transform:uppercase;letter-spacing:1px">Total Score</div>
            <div class="big-score">${totalStars}</div>
            <div style="background:rgba(255,255,255,0.1);border-radius:12px;padding:15px;margin-top:10px">
                <div style="font-size:12px;margin-bottom:5px;opacity:0.7">ç«ç®­æ”¶è—é¦† (${rockets})</div>
                <div class="icons-grid" style="font-size:20px">${rocketsHtml}</div>
            </div>
             <div style="background:rgba(255,255,255,0.1);border-radius:12px;padding:15px;margin-top:10px">
                <div style="font-size:12px;margin-bottom:5px;opacity:0.7">å½“å‰è¿›åº¦ (${currentStars}/10)</div>
                <div class="icons-grid">${starsHtml}</div>
            </div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 10px 0">å•è¯å¢™ (${allMasteredWords.size})</h3>
        <div class="word-wall">${wallHtml || '<span style="color:#999;font-size:13px">è¿˜æ²¡æœ‰æŒæ¡å•è¯å“¦</span>'}</div>
      </div>
      <h3 style="margin-left:5px;margin-top:20px">ç»ƒä¹ è¶³è¿¹</h3>
      <div class="history-list">
        ${historyHtml}
      </div>
    `;
  });
}

function toggleHistory(idx) {
    const el = document.getElementById(`hist-detail-${idx}`);
    if(el) { el.classList.toggle('show'); }
}

// --- LOGIC: SAVE/IMPORT/EXPORT ---
function saveSet() {
  const date = document.getElementById('newDate').value;
  const text = document.getElementById('newWords').value;
  if(!text.trim()) return alert("è¯·è¾“å…¥å•è¯");
  const words = text.split(/\n+/).map(w => w.trim()).filter(w => w);
  const tx = db.transaction('wordSets', 'readwrite');
  tx.objectStore('wordSets').put({ date, words });
  tx.oncomplete = () => { alert("ä¿å­˜æˆåŠŸ!"); renderWordManager(); };
}

function deleteSetByDate() {
  const date = document.getElementById('newDate').value;
  if(!confirm(`ç¡®è®¤åˆ é™¤ ${date} çš„æ‰€æœ‰å•è¯å—ï¼Ÿ`)) return;
  const tx = db.transaction('wordSets', 'readwrite');
  tx.objectStore('wordSets').delete(date);
  tx.oncomplete = () => { alert("å·²åˆ é™¤"); renderWordManager(); };
}

function exportAllData() {
  const tx = db.transaction(['wordSets', 'wrongBank', 'practiceLogs'], 'readonly');
  Promise.all([
    getAll(tx.objectStore('wordSets')), 
    getAll(tx.objectStore('wrongBank')),
    getAll(tx.objectStore('practiceLogs'))
  ])
  .then(([sets, wrongs, logs]) => {
      const data = { wordSets: sets, wrongBank: wrongs, practiceLogs: logs, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `romeo_backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
  });
}

function importData(inputElement) {
  const file = inputElement.files[0];
  if (!file) return;
  if(!confirm("âš ï¸ è­¦å‘Šï¼šæ¢å¤æ•°æ®å°†ä¼šã€æ¸…ç©ºã€‘å½“å‰è®¾å¤‡ä¸Šæ‰€æœ‰çš„å†å²è®°å½•å’Œå•è¯ï¼Œå®Œå…¨æ›¿æ¢ä¸ºå¤‡ä»½æ–‡ä»¶é‡Œçš„å†…å®¹ã€‚\n\nç¡®å®šè¦è¦†ç›–å—ï¼Ÿ")) {
     inputElement.value = ''; 
     return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.wordSets && !data.wrongBank && !data.practiceLogs) throw new Error("Format error");
      const tx = db.transaction(['wordSets', 'wrongBank', 'practiceLogs'], 'readwrite');
      
      tx.objectStore('wordSets').clear();
      tx.objectStore('wrongBank').clear();
      tx.objectStore('practiceLogs').clear();
      
      (data.wordSets || []).forEach(s => tx.objectStore('wordSets').put(s));
      (data.wrongBank || []).forEach(w => tx.objectStore('wrongBank').put(w));
      (data.practiceLogs || []).forEach(l => tx.objectStore('practiceLogs').put(l));
      
      tx.oncomplete = () => { alert("æ¢å¤æˆåŠŸï¼"); renderHome(); inputElement.value = ''; };
    } catch (err) { alert("æ–‡ä»¶é”™è¯¯"); inputElement.value = ''; }
  };
  reader.readAsText(file);
}

// --- LOGIC: PRACTICE CORE ---
function startPractice(date) {
  const tx = db.transaction('wordSets', 'readonly');
  tx.objectStore('wordSets').get(date).onsuccess = (e) => {
    const data = e.target.result;
    if(!data) return;
    currentSetDate = date;
    practiceList = data.words;
    currentIndex = 0;
    stage = 1; wrongList = []; sessionMasteredSet = new Set();
    renderPracticeUI();
  };
}

function renderWrongPractice() {
  const tx = db.transaction('wrongBank', 'readonly');
  getAll(tx.objectStore('wrongBank')).then(list => {
    if(list.length === 0) return alert("é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼");
    currentSetDate = 'wrong_bank';
    practiceList = list.map(i => i.word);
    currentIndex = 0;
    stage = 2; wrongList = []; sessionMasteredSet = new Set();
    renderPracticeUI();
  });
}

function renderPracticeUI() {
  headerBtn.innerHTML = `<button class="btn-small" onclick="if(confirm('é€€å‡ºç»ƒä¹ ï¼Ÿ')) renderHome()">ğŸƒ é€€å‡º</button>`;
  let title = stage === 1 ? "ç¬¬ä¸€è½®: è®¤è¯»è®°å¿†" : (stage === 2 ? "ç¬¬äºŒè½®: å¬å†™è€ƒæ ¸" : "é”™é¢˜é‡ç»ƒ");
  if(currentSetDate === 'wrong_bank') title = "é”™é¢˜çªå‡»";
  
  app.innerHTML = `
    <div style="text-align:center;margin-bottom:15px;color:#888;font-weight:600;font-size:14px">
        ${title} â€¢ <span style="color:var(--primary)">${currentIndex + 1} / ${practiceList.length}</span>
    </div>
    <div class="card" id="practiceCard" style="min-height:300px"></div>
  `;
  loadWord();
}

function loadWord() {
  if(currentIndex >= practiceList.length) { handleRoundComplete(); return; }
  
  const rawWord = practiceList[currentIndex];
  const cleanWord = rawWord.replace(/[\/\-]/g, ''); 
  const container = document.getElementById('practiceCard');
  
  let phonicsDisplay = "";
  if(stage === 1) {
      if(rawWord.includes('/') || rawWord.includes('-')) {
          phonicsDisplay = rawWord.replace(/[\/\-]/g, ' Â· ');
      } else {
          phonicsDisplay = getImprovedPhonics(cleanWord);
      }
  }

  const displayWord = stage === 1 ? cleanWord : "???";
  
  container.innerHTML = `
    <div class="word-display">
        <div class="word-text" style="color:${stage===1?'#111':'#ccc'}">${displayWord}</div>
        ${phonicsDisplay ? `<div class="phonics">${phonicsDisplay}</div>` : '<div style="height:38px"></div>'}
    </div>
    
    <div style="text-align:center;margin-bottom:20px">
        <button class="btn-outline" style="display:inline-flex;width:auto;padding:10px 20px;border-radius:30px;align-items:center;gap:5px" onclick="speak('${cleanWord}')">
            <span>ğŸ”Š</span> <span style="font-weight:600">å¬å‘éŸ³</span>
        </button>
    </div>

    <div class="blanks-container" id="blanksArea"></div>
    <div style="text-align:center;height:30px;margin-bottom:10px;font-weight:bold;font-size:18px" id="feedback"></div>

    <button class="btn btn-primary" id="confirmBtn" onclick="checkWord()">âœ¨ ç¡®è®¤ (Enter)</button>
    <button class="btn btn-outline" id="skipBtn" style="margin-top:0;border:none;color:#999" onclick="skipWord()">è·³è¿‡ â€º</button>
  `;
  setupInput(cleanWord);
  setTimeout(() => speak(cleanWord), 400);
}

// --- LOGIC: INPUT & CHECK ---
let targetWord = "";
let currentInput = "";

function setupInput(word) {
  targetWord = word; currentInput = "";
  const blanks = document.getElementById('blanksArea'); blanks.innerHTML = '';
  for(let i=0; i<word.length; i++) {
    const b = document.createElement('div'); b.className = 'blank-char';
    if(word[i] === ' ' || word[i] === '-') { b.textContent = word[i]; b.style.borderBottom = 'none'; }
    blanks.appendChild(b);
  }
  const hidden = document.getElementById('hiddenInput');
  hidden.value = ''; hidden.focus();
  blanks.onclick = () => { hidden.focus(); updateBlanksUI(); };
  hidden.oninput = (e) => { 
      let val = e.target.value.replace(/[^a-zA-Z]/g, '');
      currentInput = val.slice(0, targetWord.length); 
      updateBlanksUI(); 
  };
  hidden.onkeydown = (e) => { if(e.key === 'Enter') checkWord(); };
  updateBlanksUI();
}

function updateBlanksUI() {
  const chars = document.querySelectorAll('.blank-char');
  for(let i=0; i<targetWord.length; i++) {
    if(targetWord[i] === ' ' || targetWord[i] === '-') continue;
    const charElem = chars[i];
    const inputChar = currentInput[i] || '';
    charElem.textContent = inputChar;
    charElem.classList.remove('active', 'filled');
    if(i === currentInput.length) charElem.classList.add('active');
    if(inputChar) charElem.classList.add('filled');
  }
}

function checkWord() {
  const fb = document.getElementById('feedback');
  const cleanInput = currentInput.trim().toLowerCase();
  const cleanTarget = targetWord.trim().toLowerCase();
  
  if(!cleanInput) return; 
  
  if(cleanInput === cleanTarget) {
    fb.innerHTML = `<span style="color:var(--success)">å¤ªæ£’äº†ï¼ğŸ‰</span>`;
    document.querySelectorAll('.blank-char').forEach(c => c.classList.add('correct'));
    playSuccessTone();

    if(stage >= 2) { 
        sessionMasteredSet.add(cleanTarget); 
        if(currentSetDate === 'wrong_bank') removeFromWrongBank(targetWord);
    }
    setTimeout(() => { currentIndex++; loadWord(); }, 800);
  } else {
    fb.innerHTML = `<span style="color:var(--lego-red)">æ­£ç¡®: ${targetWord}</span>`;
    document.querySelectorAll('.blank-char').forEach(c => c.classList.add('wrong'));
    const btn = document.getElementById('confirmBtn');

    if(stage === 1) {
        btn.innerText = "è®°ä½äº† (æ¸…ç©ºé‡è¯•) â†º";
        btn.className = "btn btn-yellow";
        btn.onclick = () => {
            currentInput = "";
            document.getElementById('hiddenInput').value = "";
            updateBlanksUI();
            document.querySelectorAll('.blank-char').forEach(c => c.classList.remove('wrong'));
            fb.innerHTML = "";
            btn.innerText = "âœ¨ ç¡®è®¤ (Enter)";
            btn.className = "btn btn-primary";
            btn.onclick = checkWord;
            document.getElementById('hiddenInput').focus();
        };
    } else {
        if(stage === 2) { 
            const rawW = practiceList[currentIndex];
            if(!wrongList.includes(rawW)) wrongList.push(rawW); 
            addToWrongBank(rawW); 
        }
        btn.innerText = "è®°ä½äº†ï¼Œç»§ç»­ â€º";
        btn.className = "btn btn-outline";
        btn.onclick = () => { currentIndex++; loadWord(); };
    }
  }
}

function skipWord() { currentIndex++; loadWord(); }

function handleRoundComplete() {
  if(stage === 1) { 
    alert("ç¬¬ä¸€è½®è®°å¿†å®Œæˆï¼\nè¯·å‡†å¤‡å¥½ï¼Œæ¥ä¸‹æ¥å¼€å§‹å¬å†™æŒ‘æˆ˜ ğŸ’ª"); 
    stage = 2; currentIndex = 0; renderPracticeUI(); 
  } else if (stage === 2) {
    if(wrongList.length > 0) { 
      alert(`å¬å†™å®Œæˆï¼æœ‰ ${wrongList.length} ä¸ªå•è¯éœ€è¦è®¢æ­£ã€‚`); 
      practiceList = [...wrongList]; wrongList = []; stage = 3; currentIndex = 0; renderPracticeUI(); 
    } else {
      finishAll();
    }
  } else {
    finishAll();
  }
}

function finishAll() {
  const masteredCount = sessionMasteredSet.size;
  if(masteredCount > 0) {
    const tx = db.transaction('practiceLogs', 'readwrite');
    tx.objectStore('practiceLogs').add({
        date: new Date().toISOString().slice(0,10),
        timestamp: Date.now(),
        count: masteredCount,
        words: Array.from(sessionMasteredSet), 
        source: currentSetDate
    });
  }
  app.innerHTML = `
    <div class="card" style="text-align:center;padding:50px 20px;margin-top:40px">
      <div style="font-size:70px;margin-bottom:10px">ğŸš€</div>
      <h2 style="font-size:28px;margin-bottom:10px;color:#333;font-weight:800">ç»ƒä¹ å®Œæˆï¼</h2>
      <p style="color:#666;font-size:18px">æœ¬æ¬¡æŒæ¡: <b style="color:#fbc02d">${masteredCount} â­</b></p>
      <div style="height:20px"></div>
      <button class="btn btn-primary" onclick="renderHome()">è¿”å›é¦–é¡µ</button>
      <button class="btn btn-yellow" onclick="renderRecords()">æŸ¥çœ‹æˆå°±</button>
    </div>
  `;
}

// --- Helpers ---
function getImprovedPhonics(w) {
    const word = w.toLowerCase();
    const chunks = word.match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi);
    if(!chunks || chunks.length <= 1) return word;
    let res = [];
    for(let i=0; i<chunks.length; i++) { res.push(chunks[i]); }
    if(res.length > 1) {
       const last = res[res.length-1];
       if(last === 'e' || last === 'es') { res[res.length-2] += res.pop(); }
    }
    return res.join(' Â· ');
}

function getAll(store) { return new Promise((r) => { const req = store.getAll(); req.onsuccess = () => r(req.result); }); }
function addToWrongBank(word) { 
  const tx = db.transaction('wrongBank', 'readwrite'); 
  tx.objectStore('wrongBank').put({ word: word, lastWrong: new Date().toISOString() }); 
}
function removeFromWrongBank(word) { 
  const tx = db.transaction('wrongBank', 'readwrite'); 
  tx.objectStore('wrongBank').delete(word); 
}
function speak(text) {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9;
  const allVoices = speechSynthesis.getVoices();
  const preferred = allVoices.find(v => v.name === 'Daniel') || allVoices.find(v => v.name === 'Samantha') || allVoices.find(v => v.lang.includes('en'));
  if(preferred) u.voice = preferred;
  speechSynthesis.speak(u);
}
speechSynthesis.onvoiceschanged = () => { };
</script>
</body>
</html>
